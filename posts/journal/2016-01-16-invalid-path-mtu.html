<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="zh_cn" <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>2016-01-16-invalid-path-mtu</title>
        <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="../../css/bootstrap-theme.min.css" />
        <link rel="stylesheet" type="text/css" href="../../css/blog.css" />
        <script src="../../js/jquery.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
    </head>
    <body>
        <nav class="navbar-solarized">
            <div class>
                <div class="logo">
                    <a href="../../">some useless technologies</a>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <div id="content">
                    <div class="post">
    <h1 class="title"><a href="../../posts/journal/2016-01-16-invalid-path-mtu.html">2016-01-16-invalid-path-mtu</a>
        <span>
            January 16, 2016
        </span>
        
    </h1>
    <h2 id="深圳-vpn-mtu-问题">深圳 VPN MTU 问题</h2>
<p>近来一直发现深圳的机器连接北京的 ERP 系统时，如果数据包比较大就会出现服务器响 应超时。问题发现后，首先使用深圳的 Mikrotik 设备上的 http client 发送了一个大 包进行排查。为了构造一个较大的数据包，在 GET 的参数里添加一些无用的数据。</p>
<pre><code>/tool fetch url=&quot;http://10.0.8.32:8810/index.html\?id=1111...</code></pre>
<p>然后在 Mikrotik 端和 ERP 的 NGINX 端都启动了抓包程序。在 NGINX 端抓包发现一旦 tcpdump 显示的数据包大小超过 1390 。三次握手的由 Mikrotik 发送的最后一个 ACK 包（这个包同时带有 PSH Flag 并且还携带了数据），就无法被收到。Mikrotik 端抓包 显示这个 ACK 包在不停被重传。由于问题的复现依赖于数据包的大小，因此感觉到是 Path MTU 的问题，于是开始使用不同大小的 ICMP 包进行 ping 测试</p>
<pre><code>/ping VPN网关地址 size=1392</code></pre>
<p>测试后发现只要是 size &gt; 1392 包就会被丢弃。感觉像是链路上有个地方的 MTU 配置出 错了。（考虑到 PPPoE 的默认 MTU 是 1492，1392很可能是被打错了）</p>
<p>最终无奈，只能将 Mikrotik 设备上 PPPoE 接口的 MTU 缩小，以解决这个问题。</p>
<p>附：</p>
<p>如果使用 Linux 进行 Path MTU 测试可以使用这个命令，</p>
<pre><code>ping -M dont -s 1464 114.114.114.114</code></pre>
<p><code>-s</code> 用来指定包的大小。<code>-M dont</code> 给 ICMP 包夹带 <code>don't fragment</code> 标志位，让路 由器直接丢弃过大的 ICMP 包。</p>

</div>
<hr>
<div id="more">
    - <a href="../../">home</a>
    - <a href="../../archive.html">archives</a>
    -
</div>

                    <div id="footer">
                        theme based on <a href="http://ethanschoonover.com/solarized" target="_blank">solarized</a>
                        |
                        generated by <a href="http://jaspervdj.be/hakyll" target="_blank">hakyll</a>
                        |
                        deployed by <a href="http://circleci.com" target="_blank">circleci</a>
                        |
                        hosted on <a href="http://github.com">github.io</a>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
