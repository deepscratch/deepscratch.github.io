<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="zh_cn" <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>2016-03-03-postgresql-too-many-work-mem</title>
        <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="../../css/bootstrap-theme.min.css" />
        <link rel="stylesheet" type="text/css" href="../../css/blog.css" />
        <script src="../../js/jquery.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
    </head>
    <body>
        <nav class="navbar-solarized">
            <div class>
                <div class="logo">
                    <a href="../../">some useless technologies</a>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <div id="content">
                    <div class="post">
    <h1 class="title"><a href="../../posts/journal/2016-03-03-postgresql-too-many-work-mem.html">2016-03-03-postgresql-too-many-work-mem</a>
        <span>
            March  3, 2016
        </span>
        
    </h1>
    <h1 id="postgresql-work_mem-不宜设置过大">PostgreSQL: work_mem 不宜设置过大</h1>
<p>今天一台 postgresql 机器 swap 报警。大约占用了 2GB 的 swap 空间。登陆机器后， 首先通过 <code>/proc</code> 文件系统找到了使用 swap 较多的进程。</p>
<pre><code>grep  'VmSwap:' /proc/*/status   | sort -n -k 2</code></pre>
<p>发现 swap 占用最多的进程都是 postgres 的服务进程。然后在核实了系统的 <code>vm.swappiness</code> 确实已经设置为 0 的情况下，开始怀疑是 postgres 配置了过多的内 存。</p>
<p>考虑到 swap 是用来交换系统匿名页(anonymous pages)的，匿名页是通过 malloc 系列 函数产生的内存分配，因此怀疑是 postgres 的 <code>work_mem</code> 配置有问题。查看 postgres.conf 后发现，work_mem 被配置成了 10GB 。虽然系统内存总共是 128 GB，但 是按照 PostgreSQL 文档的描述[^1]，每个服务进程至少会分配 work_mem 大小的内存进 行排序等操作。通过 netstat -ant 了解到机器上的服务进程一共有将近 200 个，并且 大多用于进行统计等业务。这也基本符合 <code>work_mem</code> 设置过大从而导致内存使用过多的 特征。</p>
<p>对于 work_mem 文档中做了以下描述：</p>
<blockquote>
<p>Note that for a complex query, several sort or hash operations might be running in parallel; each operation will be allowed to use as much memory as this value specifies before it starts to write data into temporary files</p>
</blockquote>
<p>即可并行化的 SQL 会导致多份 work_mem 大小的内存被分配。因此，文档中也特别强调，</p>
<blockquote>
<p>Therefore, the total memory used could be many times the value of work_mem;</p>
</blockquote>
<p>[^1] http://www.postgresql.org/docs/9.4/static/runtime-config-resource.html</p>

</div>
<hr>
<div id="more">
    - <a href="../../">home</a>
    - <a href="../../archive.html">archives</a>
    -
</div>

                    <div id="footer">
                        theme based on <a href="http://ethanschoonover.com/solarized" target="_blank">solarized</a>
                        |
                        generated by <a href="http://jaspervdj.be/hakyll" target="_blank">hakyll</a>
                        |
                        deployed by <a href="http://circleci.com" target="_blank">circleci</a>
                        |
                        hosted on <a href="http://github.com">github.io</a>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
